#!/bin/bash

set -e

DRY_RUN=false
VERBOSE=false

usage() {
    echo "Usage: $0 [-n] [-v]" >&2
    echo "  -n  dry run, show actions without executing" >&2
    echo "  -v  verbose output" >&2
}

while getopts ":nv" opt; do
    case "$opt" in
        n) DRY_RUN=true ;;
        v) VERBOSE=true ;;
        *) usage; exit 1 ;;
    esac
done
shift $((OPTIND-1))

OS=$(uname)
DOTFILES=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

log() {
    [ "$VERBOSE" = true ] && echo "$@"
}

link_file() {
    local src="$1" dest="$2"
    local backup_base backup_path

    if [ ! -e "$src" ]; then
        echo "Error: source '$src' does not exist" >&2
        exit 1
    fi

    mkdir -p "$(dirname "$dest")"

    # If destination is already the expected symlink, leave it alone.
    if [ -L "$dest" ] && [ "$(readlink "$dest")" = "$src" ]; then
        log "Already linked: $dest -> $src"
        return 0
    fi

    # Never delete user data. Move existing paths to a timestamped backup.
    if [ -e "$dest" ] || [ -L "$dest" ]; then
        backup_base="${dest}.backup.$(date +%Y%m%d%H%M%S)"
        backup_path="$backup_base"
        while [ -e "$backup_path" ] || [ -L "$backup_path" ]; do
            backup_path="${backup_base}.$RANDOM"
        done

        log "Backing up existing $dest -> $backup_path"
        if [ "$DRY_RUN" = false ]; then
            mv "$dest" "$backup_path"
        fi
    fi

    log "ln -s $src $dest"
    if [ "$DRY_RUN" = false ]; then
        ln -s "$src" "$dest" || { echo "Failed to link $src -> $dest" >&2; exit 1; }
    fi
}

# common directories
mkdir -p "$HOME/.local/bin" "$HOME/.config" "$HOME/Library/Application Support" 2>/dev/null || true

link_file "$DOTFILES/.zshrc" "$HOME/.zshrc"
link_file "$DOTFILES/tmux/tmux.conf" "$HOME/.tmux.conf"
link_file "$DOTFILES/nvim" "$HOME/.config/nvim"
link_file "$DOTFILES/wezterm" "$HOME/.config/wezterm"

link_file "$DOTFILES/.gitignore" "$HOME/.gitignore"

P10K_DIR="$HOME/bin/.powerlevel10k"
if [ ! -d "$P10K_DIR" ]; then
    log "Installing powerlevel10k"
    if [ "$DRY_RUN" = false ]; then
        mkdir -p "$HOME/bin"
        git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "$P10K_DIR"
    fi
else
    log "powerlevel10k already installed"
fi
