#!/usr/bin/env python3

import os
import sys
import argparse
from dotenv import load_dotenv
from transmission_rpc import Client

load_dotenv()

def get_client():
    return Client(
        host=os.getenv("HOME_IP"),
        port=os.getenv("HOME_TRANSMISSION_PORT"),
        username=os.getenv("HOME_TRANSMISSION_USERNAME"),
        password=os.getenv("HOME_TRANSMISSION_PASSWORD")
    )

def format_speed(bps):
    """Converts bytes per second to human-readable string."""
    if bps == 0 or bps is None: return "0 B/s"
    units = ["B/s", "KB/s", "MB/s", "GB/s"]
    i = 0
    while bps >= 1024 and i < len(units) - 1:
        bps /= 1024
        i += 1
    return f"{bps:.1f} {units[i]}"

def print_torrent_table(torrents, title="Torrents"):
    print(f"\n--- {title} ---")
    header = f"{'ID':<5} | {'Status':<12} | {'Progress':<10} | {'Speed':<10} | {'Name'}"
    print(header)
    print("-" * 80)

    for t in torrents:
        prog = f"{t.progress:.1f}%"
        speed = format_speed(t.rate_download)
        print(f"{t.id:<5} | {t.status:<12} | {prog:<10} | {speed:<10} | {t.name}")

def main():
    parser = argparse.ArgumentParser(description="Transmission CLI Controller")

    parser.add_argument("--list", action="store_true", help="List all torrents")
    parser.add_argument("--stopped", action="store_true", help="List only stopped torrents")
    parser.add_argument("--downloading", action="store_true", help="List only downloading torrents")
    parser.add_argument("--pause-all", action="store_true", help="Pause all torrents")
    parser.add_argument("--start-all", action="store_true", help="Start all torrents")
    parser.add_argument("--start", type=int, nargs='+', help="Start torrents by ID(s)")
    parser.add_argument("--stop", type=int, nargs='+', help="Stop torrents by ID(s)")

    if len(sys.argv) == 1:
        parser.print_help()
        sys.exit(0)

    args = parser.parse_args()
    c = get_client()

    if args.pause_all:
        c.stop_torrent("all")
        print("Successfully paused all torrents.")

    if args.start_all:
        c.start_torrent("all")
        print("Successfully started all torrents.")

    if args.start:
        c.start_torrent(args.start)
        print(f"Started torrent IDs: {args.start}")

    if args.stop:
        c.stop_torrent(args.stop)
        print(f"Stopped torrent IDs: {args.stop}")

    torrents = c.get_torrents()

    if args.list:
        print_torrent_table(torrents, "All Torrents")

    if args.stopped:
        stopped_list = [t for t in torrents if t.status == "stopped"]
        print_torrent_table(stopped_list, "Stopped Torrents")

    if args.downloading:
        download_list = [t for t in torrents if t.status == "downloading"]
        print_torrent_table(download_list, "Downloading Torrents")

if __name__ == "__main__":
    main()
