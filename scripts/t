#!/bin/bash

# Helper to create or attach to tmux sessions for project directories.
# If no directory is provided, fzf is used to select one from common locations.

set -e

usage() {
    echo "Usage: $0 [DIRECTORY]" >&2
    exit 1
}

# Determine the directory to open
if [[ $# -gt 1 ]]; then
    usage
fi

if [[ $# -eq 1 ]]; then
    project_dir=$1
else
    declare -a candidates=()

    if [[ -d "$HOME/Code/Herd" ]]; then
        while IFS= read -r dir; do
            candidates+=("$dir")
        done < <(find "$HOME/Code/Herd" -maxdepth 1 -mindepth 1 -type d ! -name ".flux")
    fi

    if [[ -d "$HOME/bin" ]]; then
        while IFS= read -r dir; do
            candidates+=("$dir")
        done < <(find "$HOME/bin" -maxdepth 0)
    fi

    if [[ ${#candidates[@]} -eq 0 ]]; then
        echo "No directories found to choose from" >&2
        exit 1
    fi

    if command -v fzf >/dev/null 2>&1; then
        project_dir=$(printf '%s\n' "${candidates[@]}" | fzf)
    else
        echo "fzf not found; falling back to a simple selector." >&2
        PS3="Select project directory: "
        select dir in "${candidates[@]}"; do
            if [[ -n "$dir" ]]; then
                project_dir="$dir"
                break
            else
                echo "Invalid selection" >&2
            fi
        done
        unset PS3
    fi
fi

if [[ -z "$project_dir" || ! -d "$project_dir" ]]; then
    echo "No valid directory selected" >&2
    usage
fi

session_name=$(basename "$project_dir" | sed 's/\./_/g')

if [[ -n "$TMUX" ]]; then
    tmux -u new-session -A -d -s "$session_name" -c "$project_dir"
    tmux -u switch-client -t "$session_name"
else
    tmux -u new-session -A -s "$session_name" -c "$project_dir"
fi
