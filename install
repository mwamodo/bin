#!/bin/bash

set -e

DRY_RUN=false
VERBOSE=false

usage() {
    echo "Usage: $0 [-n] [-v]" >&2
    echo "  -n  dry run, show actions without executing" >&2
    echo "  -v  verbose output" >&2
}

while getopts ":nv" opt; do
    case "$opt" in
        n) DRY_RUN=true ;;
        v) VERBOSE=true ;;
        *) usage; exit 1 ;;
    esac
done
shift $((OPTIND-1))

OS=$(uname)
DOTFILES=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

log() {
    [ "$VERBOSE" = true ] && echo "$@"
}

link_file() {
    local src="$1" dest="$2"

    if [ ! -e "$src" ]; then
        echo "Error: source '$src' does not exist" >&2
        exit 1
    fi

    # Remove existing destination if it exists
    if [ -e "$dest" ]; then
        log "Removing existing $dest"
        if [ "$DRY_RUN" = false ]; then
            rm -rf "$dest"
        fi
    fi

    log "ln -sf $src $dest"
    if [ "$DRY_RUN" = false ]; then
        ln -sf "$src" "$dest" || { echo "Failed to link $src -> $dest" >&2; exit 1; }
    fi
}

# common directories
mkdir -p "$HOME/.local/bin" "$HOME/.config" "$HOME/Library/Application Support" 2>/dev/null || true

link_file "$DOTFILES/.zshrc" "$HOME/.zshrc"
link_file "$DOTFILES/tmux/tmux.conf" "$HOME/.tmux.conf"
link_file "$DOTFILES/nvim" "$HOME/.config/nvim"
link_file "$DOTFILES/wezterm" "$HOME/.config/wezterm"

link_file "$DOTFILES/.gitignore" "$HOME/.gitignore"

# todo: install powerlevel10k
# git clone git@github.com:romkatv/powerlevel10k.git "$HOME/bin/.powerlevel10k"
